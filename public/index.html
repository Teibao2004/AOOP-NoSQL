<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmes MongoDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .movie-card {
            height: 100%;
            transition: transform 0.3s;
        }
        .movie-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .movie-poster {
            height: 300px;
            object-fit: cover;
        }
        .votos {
            color: #6c757d;
            font-size: 12px;
        }
        .filters-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .filter-label {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .genre-badge {
            display: inline-block;
            margin: 2px;
            cursor: pointer;
        }
        .genre-badge.active {
            background-color: #0d6efd !important;
            color: white;
        }
        #movies-container {
            min-height: 400px;
        }
        #no-results {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Filmes MongoDB</a>
            <form class="d-flex" id="search-form">
                <input class="form-control me-2" type="search" placeholder="Buscar filmes..." id="search-input">
                <button class="btn btn-outline-light" type="submit">Buscar</button>
            </form>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 id="page-title">Filmes</h1>
        
        <!-- Filtros avançados -->
        <div class="filters-container">
            <div class="row mb-3">
                <div class="col-12">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                        <i class="fas fa-filter"></i> Filtros avançados
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" id="clear-filters" style="display: none;">
                        <i class="fas fa-times"></i> Limpar filtros
                    </button>
                </div>
            </div>
            
            <div class="collapse" id="advancedFilters">
                <div class="row">
                    <!-- Categorias/Gêneros -->
                    <div class="col-md-6 mb-3">
                        <label class="filter-label">Gêneros</label>
                        <div id="genres-container">
                            <!-- Os gêneros serão inseridos aqui dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Ordenação -->
                    <div class="col-md-3 mb-3">
                        <label for="sort-by" class="filter-label">Ordenar por</label>
                        <select class="form-select" id="sort-by">
                            <option value="title:1">Título (A-Z)</option>
                            <option value="title:-1">Título (Z-A)</option>
                            <option value="year:-1">Ano (mais recente)</option>
                            <option value="year:1">Ano (mais antigo)</option>
                            <option value="imdb.rating:-1" selected>Avaliação (maior)</option>
                            <option value="imdb.rating:1">Avaliação (menor)</option>
                            <option value="imdb.votes:-1">Popularidade</option>
                        </select>
                    </div>
                    
                    <!-- Ano -->
                    <div class="col-md-3 mb-3">
                        <label for="year-filter" class="filter-label">Ano</label>
                        <select class="form-select" id="year-filter">
                            <option value="">Todos os anos</option>
                            <!-- Anos serão gerados dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Classificação -->
                    <div class="col-md-3 mb-3">
                        <label class="filter-label">Classificação</label>
                        <div class="d-flex flex-wrap" id="rating-filter">
                            <button class="btn btn-sm btn-outline-warning me-1 mb-1" data-rating="7">7+ ⭐</button>
                            <button class="btn btn-sm btn-outline-warning me-1 mb-1" data-rating="8">8+ ⭐</button>
                            <button class="btn btn-sm btn-outline-warning me-1 mb-1" data-rating="9">9+ ⭐</button>
                        </div>
                    </div>
                    
                    <!-- Tipo -->
                    <div class="col-md-3 mb-3">
                        <label for="type-filter" class="filter-label">Tipo</label>
                        <select class="form-select" id="type-filter">
                            <option value="">Todos os tipos</option>
                            <option value="movie">Filmes</option>
                            <option value="series">Séries</option>
                            <option value="documentary">Documentários</option>
                        </select>
                    </div>
                    
                    <!-- País -->
                    <div class="col-md-3 mb-3">
                        <label for="country-filter" class="filter-label">País</label>
                        <select class="form-select" id="country-filter">
                            <option value="">Todos os países</option>
                            <!-- Países serão gerados dinamicamente -->
                        </select>
                    </div>
                    
                    <!-- Resultados por página -->
                    <div class="col-md-3 mb-3">
                        <label for="limit-filter" class="filter-label">Resultados por página</label>
                        <select class="form-select" id="limit-filter">
                            <option value="12" selected>12</option>
                            <option value="24">24</option>
                            <option value="48">48</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <button id="apply-filters" class="btn btn-primary">Aplicar filtros</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Badges para filtros ativos -->
        <div id="active-filters" class="mb-3"></div>
        
        <!-- Resultados -->
        <div id="movies-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"></div>
        <div id="no-results" class="text-center py-5">
            <h3>Nenhum filme encontrado</h3>
            <p>Tente ajustar seus filtros ou fazer uma nova busca.</p>
        </div>
        <div id="pagination" class="d-flex justify-content-center mt-4"></div>
        <div id="loading" class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração da API
        const API_URL = 'http://localhost:3000/api';
        let currentPage = 1;
        let totalPages = 1;
        let allGenres = [];
        let allCountries = [];
        let activeFilters = {
            genre: null,
            year: null,
            rating: null,
            type: null,
            country: null,
            sort: "imdb.rating:-1",
            limit: 12
        };

        // Elementos DOM
        const moviesContainer = document.getElementById('movies-container');
        const noResultsElement = document.getElementById('no-results');
        const paginationContainer = document.getElementById('pagination');
        const loadingElement = document.getElementById('loading');
        const pageTitle = document.getElementById('page-title');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const genresContainer = document.getElementById('genres-container');
        const yearFilter = document.getElementById('year-filter');
        const countryFilter = document.getElementById('country-filter');
        const typeFilter = document.getElementById('type-filter');
        const sortByFilter = document.getElementById('sort-by');
        const limitFilter = document.getElementById('limit-filter');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const activeFiltersContainer = document.getElementById('active-filters');
        const ratingButtons = document.querySelectorAll('#rating-filter button');

        document.addEventListener('DOMContentLoaded', async () => {
            await loadFilterOptions();
            
            const urlParams = new URLSearchParams(window.location.search);
            const genreParam = urlParams.get('genre');
            
            if (genreParam) {
                activeFilters.genre = genreParam;
                pageTitle.textContent = `Filmes do gênero: ${genreParam}`;
                
                setTimeout(() => {
                    document.querySelectorAll('.genre-badge').forEach(badge => {
                        if (badge.dataset.genre === genreParam) {
                            badge.classList.add('active');
                        }
                    });
                    
                    clearFiltersBtn.style.display = 'inline-block';
                    
                    fetchMoviesWithFilters();
                }, 500);
            } else {
                fetchMovies();
            }
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                pageTitle.textContent = `Resultados para: "${query}"`;
                searchMovies(query);
                clearActiveFilters();
            }
        });

        applyFiltersBtn.addEventListener('click', () => {
            currentPage = 1;
            fetchMoviesWithFilters();
        });

        clearFiltersBtn.addEventListener('click', () => {
            clearAllFilters();
            fetchMovies();
        });

        // Adicionar event listeners para os botões de classificação
        ratingButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                ratingButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                activeFilters.rating = parseFloat(button.getAttribute('data-rating'));
            });
        });

        sortByFilter.addEventListener('change', () => {
            activeFilters.sort = sortByFilter.value;
        });

        limitFilter.addEventListener('change', () => {
            activeFilters.limit = parseInt(limitFilter.value);
        });

        yearFilter.addEventListener('change', () => {
            activeFilters.year = yearFilter.value ? parseInt(yearFilter.value) : null;
        });

        typeFilter.addEventListener('change', () => {
            activeFilters.type = typeFilter.value || null;
        });

        countryFilter.addEventListener('change', () => {
            activeFilters.country = countryFilter.value || null;
        });

        // Funções de API
        async function fetchMovies(page = 1, limit = 12) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                renderMovies(data.movies);
                currentPage = data.currentPage;
                totalPages = data.totalPages;
                renderPagination();
            } catch (error) {
                console.error('Erro ao carregar filmes:', error);
                showNoResults('Erro ao carregar filmes. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function fetchMoviesWithFilters(page = 1) {
            showLoading();
            updateActiveFiltersDisplay();
            clearFiltersBtn.style.display = 'inline-block';
            
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('limit', activeFilters.limit);
            
            if (activeFilters.genre) params.append('genre', activeFilters.genre);
            if (activeFilters.year) params.append('year', activeFilters.year);
            if (activeFilters.rating) params.append('min_rating', activeFilters.rating);
            if (activeFilters.type) params.append('type', activeFilters.type);
            if (activeFilters.country) params.append('country', activeFilters.country);
            
            if (activeFilters.sort) {
                const [field, order] = activeFilters.sort.split(':');
                params.append('sort_by', field);
                params.append('sort_order', order);
            }
            
            try {
                const response = await fetch(`${API_URL}/movies/filter?${params.toString()}`);
                const data = await response.json();
                
                if (data.movies && data.movies.length > 0) {
                    renderMovies(data.movies);
                    currentPage = data.currentPage || 1;
                    totalPages = data.totalPages || 1;
                    renderPagination();
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Erro ao filtrar filmes:', error);
                showNoResults('Erro ao aplicar filtros. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function searchMovies(query) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies/search?query=${encodeURIComponent(query)}`);
                const movies = await response.json();
                
                if (movies && movies.length > 0) {
                    renderMovies(movies);
                    paginationContainer.innerHTML = ''; // Sem paginação para resultados de busca
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Erro na busca:', error);
                showNoResults('Erro ao buscar filmes. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function loadFilterOptions() {
            try {
                // Obter todos os gêneros
                const genresResponse = await fetch(`${API_URL}/movies/genres`);
                allGenres = await genresResponse.json();
                renderGenresFilter(allGenres);
                
                // Obter todos os países
                const countriesResponse = await fetch(`${API_URL}/movies/countries`);
                allCountries = await countriesResponse.json();
                renderCountriesFilter(allCountries);
                
                // Gerar opções de anos (de 1900 até o ano atual)
                renderYearsFilter();
                
            } catch (error) {
                console.error('Erro ao carregar opções de filtro:', error);
            }
        }

        // Funções de Renderização
        function renderMovies(movies) {
            if (!movies || movies.length === 0) {
                showNoResults();
                return;
            }

            noResultsElement.style.display = 'none';
            moviesContainer.style.display = 'flex';
            moviesContainer.innerHTML = '';
            
            movies.forEach(movie => {
                const posterUrl = movie.poster && movie.poster !== '' ? movie.poster : 'assets/sem-poster.jpg';
                const rating = movie.imdb?.rating ? movie.imdb.rating.toFixed(1) : 'N/A';
                
                const movieElement = document.createElement('div');
                movieElement.className = 'col';
                movieElement.innerHTML = `
                    <div class="card movie-card">
                        <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}" onerror="this.onerror=null; this.src='assets/sem-poster.jpg';">
                        <div class="card-body">
                            <h5 class="card-title">${movie.title}</h5>
                            <p class="card-text text-muted">${movie.year || 'Ano desconhecido'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-warning text-dark">⭐ ${rating}</span>
                                <a href="movie-details.html?id=${movie._id}" class="btn btn-sm btn-primary">Ver detalhes</a>
                            </div>
                        </div>
                    </div>
                `;
                
                moviesContainer.appendChild(movieElement);
            });
        }

        function renderGenresFilter(genres) {
            genresContainer.innerHTML = '';
            
            genres.forEach(genre => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-light text-dark genre-badge';
                badge.textContent = genre;
                badge.dataset.genre = genre;
                
                badge.addEventListener('click', () => {
                    // Toggle active class
                    document.querySelectorAll('.genre-badge').forEach(b => b.classList.remove('active'));
                    
                    if (activeFilters.genre === genre) {
                        // Desativar filtro se já estava ativo
                        activeFilters.genre = null;
                    } else {
                        // Ativar filtro
                        badge.classList.add('active');
                        activeFilters.genre = genre;
                    }
                });
                
                genresContainer.appendChild(badge);
            });
        }

        function renderCountriesFilter(countries) {
            countryFilter.innerHTML = '<option value="">Todos os países</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        function renderYearsFilter() {
            yearFilter.innerHTML = '<option value="">Todos os anos</option>';
            
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1900; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            }
        }

        function renderPagination() {
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageButton = (page, text, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isActive ? 'active' : ''}`;
                
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = text;
                
                if (page) {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (Object.values(activeFilters).some(val => val !== null)) {
                            fetchMoviesWithFilters(page);
                        } else {
                            fetchMovies(page, activeFilters.limit);
                        }
                    });
                }
                
                li.appendChild(a);
                return li;
            };
            
            const ul = document.createElement('ul');
            ul.className = 'pagination';
            
            // Botão anterior
            ul.appendChild(createPageButton(currentPage > 1 ? currentPage - 1 : null, 'Anterior', false));
            
            // Páginas
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                ul.appendChild(createPageButton(i, i.toString(), i === currentPage));
            }
            
            // Botão próximo
            ul.appendChild(createPageButton(currentPage < totalPages ? currentPage + 1 : null, 'Próximo', false));
            
            paginationContainer.appendChild(ul);
        }

        function updateActiveFiltersDisplay() {
            activeFiltersContainer.innerHTML = '';
            let hasActiveFilters = false;
            
            // Criar badges para cada filtro ativo
            if (activeFilters.genre) {
                createFilterBadge('Gênero', activeFilters.genre, () => {
                    activeFilters.genre = null;
                    document.querySelectorAll('.genre-badge').forEach(b => b.classList.remove('active'));
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.year) {
                createFilterBadge('Ano', activeFilters.year, () => {
                    activeFilters.year = null;
                    yearFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.rating) {
                createFilterBadge('Classificação', `${activeFilters.rating}+ ⭐`, () => {
                    activeFilters.rating = null;
                    ratingButtons.forEach(btn => btn.classList.remove('active'));
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.type) {
                const typeText = {
                    'movie': 'Filmes',
                    'series': 'Séries',
                    'documentary': 'Documentários'
                }[activeFilters.type] || activeFilters.type;
                
                createFilterBadge('Tipo', typeText, () => {
                    activeFilters.type = null;
                    typeFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.country) {
                createFilterBadge('País', activeFilters.country, () => {
                    activeFilters.country = null;
                    countryFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (hasActiveFilters) {
                clearFiltersBtn.style.display = 'inline-block';
            } else {
                clearFiltersBtn.style.display = 'none';
            }
        }

        function createFilterBadge(label, value, removeCallback) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-2 mb-2';
            badge.innerHTML = `${label}: ${value} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
            
            badge.querySelector('i').addEventListener('click', removeCallback);
            activeFiltersContainer.appendChild(badge);
        }

        function clearActiveFilters() {
            activeFiltersContainer.innerHTML = '';
            document.querySelectorAll('.genre-badge').forEach(b => b.classList.remove('active'));
            ratingButtons.forEach(btn => btn.classList.remove('active'));
            
            yearFilter.value = '';
            typeFilter.value = '';
            countryFilter.value = '';
            
            clearFiltersBtn.style.display = 'none';
        }

        function clearAllFilters() {
            clearActiveFilters();
            
            // Reset todos os filtros
            activeFilters = {
                genre: null,
                year: null,
                rating: null,
                type: null,
                country: null,
                sort: "imdb.rating:-1",
                limit: 12
            };
            
            // Reset UI
            sortByFilter.value = "imdb.rating:-1";
            limitFilter.value = "12";
            pageTitle.textContent = "Filmes";
        }

        // Funções de utilidade
        function showLoading() {
            loadingElement.style.display = 'block';
            moviesContainer.style.display = 'none';
            noResultsElement.style.display = 'none';
        }

        function hideLoading() {
            loadingElement.style.display = 'none';
        }

        function showNoResults(message = null) {
            moviesContainer.style.display = 'none';
            noResultsElement.style.display = 'block';
            
            if (message) {
                noResultsElement.querySelector('p').textContent = message;
            } else {
                noResultsElement.querySelector('p').textContent = 'Tente ajustar seus filtros ou fazer uma nova busca.';
            }
            
            paginationContainer.innerHTML = '';
        }
    </script>
</body>
</html>