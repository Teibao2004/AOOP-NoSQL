<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmes MongoDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.css">
    <style>
        .movie-card {
            height: 100%;
            transition: transform 0.3s;
        }
        .movie-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .movie-poster {
            height: 300px;
            object-fit: cover;
        }
        .votos {
            color: #6c757d;
            font-size: 12px;
        }
        .filters-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .filter-label {
            font-weight: 500;
            margin-bottom: 5px;
        }
        #movies-container {
            min-height: 400px;
        }
        #no-results {
            display: none;
        }
        .genre-dropdown {
            max-height: 300px;
            overflow-y: auto;
        }
        .dropdown-item.active {
            background-color: #0d6efd;
            color: white;
        }
        .rating-slider {
            margin: 30px 10px;
        }
        .rating-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .results-per-page-btn {
            border-radius: 0;
        }
        .results-per-page-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .results-per-page-btn:first-child {
            border-top-left-radius: 0.25rem;
            border-bottom-left-radius: 0.25rem;
        }
        .results-per-page-btn:last-child {
            border-top-right-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Filmes MongoDB</a>
            <form class="d-flex" id="search-form">
                <input class="form-control me-2" type="search" placeholder="Buscar filmes..." id="search-input">
                <button class="btn btn-outline-light" type="submit">Buscar</button>
            </form>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 id="page-title">Filmes</h1>
        
        <!-- Filtros avançados -->
        <div class="filters-container">
            <div class="row mb-3">
                <div class="col-12">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                        <i class="fas fa-filter"></i> Filtros avançados
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" id="clear-filters" style="display: none;">
                        <i class="fas fa-times"></i> Limpar filtros
                    </button>
                </div>
            </div>
            
            <div class="collapse" id="advancedFilters">
                <div class="row">
                    <!-- Categorias/Gêneros (Dropdown) -->
                    <div class="col-md-6 mb-3">
                        <label class="filter-label">Gêneros</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="genreDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Selecionar gênero
                            </button>
                            <ul class="dropdown-menu genre-dropdown w-100" id="genres-container" aria-labelledby="genreDropdown">
                                <!-- Os gêneros serão inseridos aqui dinamicamente -->
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Ordenação -->
                    <div class="col-md-3 mb-3">
                        <label for="sort-by" class="filter-label">Ordenar por</label>
                        <select class="form-select" id="sort-by">
                            <option value="title:1">Título (A-Z)</option>
                            <option value="title:-1">Título (Z-A)</option>
                            <option value="year:-1">Ano (mais recente)</option>
                            <option value="year:1">Ano (mais antigo)</option>
                            <option value="imdb.rating:-1" selected>Avaliação (maior)</option>
                            <option value="imdb.rating:1">Avaliação (menor)</option>
                            <option value="imdb.votes:-1">Popularidade</option>
                        </select>
                    </div>
                    
                    <!-- Ano -->
                    <div class="col-md-3 mb-3">
                        <label for="year-filter" class="filter-label">Ano</label>
                        <select class="form-select" id="year-filter">
                            <option value="">Todos os anos</option>
                            <!-- Anos serão gerados dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Classificação (Slider) -->
                    <div class="col-md-6 mb-3">
                        <label class="filter-label">Classificação (IMDB)</label>
                        <div id="rating-slider" class="rating-slider"></div>
                        <div class="rating-values">
                            <span id="rating-min">0</span>
                            <span id="rating-max">10</span>
                        </div>
                        <input type="hidden" id="rating-min-value" value="0">
                        <input type="hidden" id="rating-max-value" value="10">
                    </div>
                    
                    <!-- Tipo -->
                    <div class="col-md-3 mb-3">
                        <label for="type-filter" class="filter-label">Tipo</label>
                        <select class="form-select" id="type-filter">
                            <option value="">Todos os tipos</option>
                            <option value="movie">Filmes</option>
                            <option value="series">Séries</option>
                            <option value="documentary">Documentários</option>
                        </select>
                    </div>
                    
                    <!-- País -->
                    <div class="col-md-3 mb-3">
                        <label for="country-filter" class="filter-label">País</label>
                        <select class="form-select" id="country-filter">
                            <option value="">Todos os países</option>
                            <!-- Países serão gerados dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Resultados por página (Botões) -->
                    <div class="col-md-6 mb-3">
                        <label class="filter-label d-block">Resultados por página</label>
                        <div class="btn-group" role="group" aria-label="Resultados por página">
                            <button type="button" class="btn btn-outline-secondary results-per-page-btn active" data-value="12">12</button>
                            <button type="button" class="btn btn-outline-secondary results-per-page-btn" data-value="18">18</button>
                            <button type="button" class="btn btn-outline-secondary results-per-page-btn" data-value="24">24</button>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mt-4">
                        <button id="apply-filters" class="btn btn-primary">Aplicar filtros</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Badges para filtros ativos -->
        <div id="active-filters" class="mb-3"></div>
        
        <!-- Resultados -->
        <div id="movies-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"></div>
        <div id="no-results" class="text-center py-5">
            <h3>Nenhum filme encontrado</h3>
            <p>Tente ajustar seus filtros ou fazer uma nova busca.</p>
        </div>
        <div id="pagination" class="d-flex justify-content-center mt-4"></div>
        <div id="loading" class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentPage = 1;
        let totalPages = 1;
        let allGenres = [];
        let allCountries = [];
        let activeFilters = {
            genre: null,
            year: null,
            minRating: 0,
            maxRating: 10,
            type: null,
            country: null,
            sort: "imdb.rating:-1",
            limit: 12
        };

        const moviesContainer = document.getElementById('movies-container');
        const noResultsElement = document.getElementById('no-results');
        const paginationContainer = document.getElementById('pagination');
        const loadingElement = document.getElementById('loading');
        const pageTitle = document.getElementById('page-title');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const genresContainer = document.getElementById('genres-container');
        const genreDropdown = document.getElementById('genreDropdown');
        const yearFilter = document.getElementById('year-filter');
        const countryFilter = document.getElementById('country-filter');
        const typeFilter = document.getElementById('type-filter');
        const sortByFilter = document.getElementById('sort-by');
        const ratingMinValue = document.getElementById('rating-min-value');
        const ratingMaxValue = document.getElementById('rating-max-value');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const activeFiltersContainer = document.getElementById('active-filters');
        const resultsPerPageBtns = document.querySelectorAll('.results-per-page-btn');

        document.addEventListener('DOMContentLoaded', async () => {
            const ratingSlider = document.getElementById('rating-slider');
            if (ratingSlider) {
                noUiSlider.create(ratingSlider, {
                    start: [0, 10],
                    connect: true,
                    step: 0.5,
                    range: {
                        'min': 0,
                        'max': 10
                    },
                    format: {
                        to: function (value) {
                            return value.toFixed(1);
                        },
                        from: function (value) {
                            return parseFloat(value);
                        }
                    }
                });

                ratingSlider.noUiSlider.on('update', function (values, handle) {
                    document.getElementById('rating-min').textContent = values[0];
                    document.getElementById('rating-max').textContent = values[1];
                    ratingMinValue.value = values[0];
                    ratingMaxValue.value = values[1];
                });
            }

            await loadFilterOptions();
            
            const urlParams = new URLSearchParams(window.location.search);
            const genreParam = urlParams.get('genre');
            
            if (genreParam) {
                activeFilters.genre = genreParam;
                pageTitle.textContent = `Filmes do gênero: ${genreParam}`;
                updateGenreDropdownText(genreParam);
                clearFiltersBtn.style.display = 'inline-block';
                fetchMoviesWithFilters();
            } else {
                fetchMovies();
            }

            resultsPerPageBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    resultsPerPageBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeFilters.limit = parseInt(btn.dataset.value);
                });
            });
        });

        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                pageTitle.textContent = `Resultados para: "${query}"`;
                searchMovies(query);
                clearActiveFilters();
            }
        });

        applyFiltersBtn.addEventListener('click', () => {
            currentPage = 1;
            activeFilters.minRating = parseFloat(ratingMinValue.value);
            activeFilters.maxRating = parseFloat(ratingMaxValue.value);
            fetchMoviesWithFilters();
        });

        clearFiltersBtn.addEventListener('click', () => {
            clearAllFilters();
            fetchMovies();
        });

        sortByFilter.addEventListener('change', () => {
            activeFilters.sort = sortByFilter.value;
        });

        yearFilter.addEventListener('change', () => {
            activeFilters.year = yearFilter.value ? parseInt(yearFilter.value) : null;
        });

        typeFilter.addEventListener('change', () => {
            activeFilters.type = typeFilter.value || null;
        });

        countryFilter.addEventListener('change', () => {
            activeFilters.country = countryFilter.value || null;
        });

        async function fetchMovies(page = 1, limit = 12) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                renderMovies(data.movies);
                currentPage = data.currentPage;
                totalPages = data.totalPages;
                renderPagination();
            } catch (error) {
                console.error('Erro ao carregar filmes:', error);
                showNoResults('Erro ao carregar filmes. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function fetchMoviesWithFilters(page = 1) {
            showLoading();
            updateActiveFiltersDisplay();
            clearFiltersBtn.style.display = 'inline-block';
            
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('limit', activeFilters.limit);
            
            if (activeFilters.genre) params.append('genre', activeFilters.genre);
            if (activeFilters.year) params.append('year', activeFilters.year);
            if (activeFilters.minRating > 0) params.append('min_rating', activeFilters.minRating);
            if (activeFilters.maxRating < 10) {
                params.append('min_rating', activeFilters.minRating);
            }
            if (activeFilters.type) params.append('type', activeFilters.type);
            if (activeFilters.country) params.append('country', activeFilters.country);
            
            if (activeFilters.sort) {
                const [field, order] = activeFilters.sort.split(':');
                params.append('sort_by', field);
                params.append('sort_order', order);
            }
            
            try {
                const response = await fetch(`${API_URL}/movies/filter?${params.toString()}`);
                const data = await response.json();
                
                if (data.movies && data.movies.length > 0) {
                    let filteredMovies = data.movies;
                    if (activeFilters.maxRating < 10) {
                        filteredMovies = data.movies.filter(movie => 
                            movie.imdb?.rating <= activeFilters.maxRating
                        );
                    }
                    
                    renderMovies(filteredMovies);
                    currentPage = data.currentPage || 1;
                    totalPages = data.totalPages || 1;
                    renderPagination();
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Erro ao filtrar filmes:', error);
                showNoResults('Erro ao aplicar filtros. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function searchMovies(query) {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/movies/search?query=${encodeURIComponent(query)}`);
                const movies = await response.json();
                
                if (movies && movies.length > 0) {
                    renderMovies(movies);
                    paginationContainer.innerHTML = '';
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Erro na busca:', error);
                showNoResults('Erro ao buscar filmes. Tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function loadFilterOptions() {
            try {
                const genresResponse = await fetch(`${API_URL}/movies/genres`);
                allGenres = await genresResponse.json();
                renderGenresDropdown(allGenres);
                
                const countriesResponse = await fetch(`${API_URL}/movies/countries`);
                allCountries = await countriesResponse.json();
                renderCountriesFilter(allCountries);
                
                renderYearsFilter();
                
            } catch (error) {
                console.error('Erro ao carregar opções de filtro:', error);
            }
        }

        function renderMovies(movies) {
            if (!movies || movies.length === 0) {
                showNoResults();
                return;
            }

            noResultsElement.style.display = 'none';
            moviesContainer.style.display = 'flex';
            moviesContainer.innerHTML = '';
            
            movies.forEach(movie => {
                const posterUrl = movie.poster && movie.poster !== '' ? movie.poster : 'assets/sem-poster.jpg';
                const rating = movie.imdb?.rating ? movie.imdb.rating.toFixed(1) : 'N/A';
                
                const movieElement = document.createElement('div');
                movieElement.className = 'col';
                movieElement.innerHTML = `
                    <div class="card movie-card">
                        <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}" onerror="this.onerror=null; this.src='assets/sem-poster.jpg';">
                        <div class="card-body">
                            <h5 class="card-title">${movie.title}</h5>
                            <p class="card-text text-muted">${movie.year || 'Ano desconhecido'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-warning text-dark">⭐ ${rating}</span>
                                <a href="movie-details.html?id=${movie._id}" class="btn btn-sm btn-primary">Ver detalhes</a>
                            </div>
                        </div>
                    </div>
                `;
                
                moviesContainer.appendChild(movieElement);
            });
        }

        function renderGenresDropdown(genres) {
            genresContainer.innerHTML = '<li><a class="dropdown-item" href="#" data-genre="">Todos os gêneros</a></li>';
            
            genres.forEach(genre => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'dropdown-item';
                link.href = '#';
                link.textContent = genre;
                link.dataset.genre = genre;
                
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#genres-container .dropdown-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    if (activeFilters.genre === genre) {
                        activeFilters.genre = null;
                        genreDropdown.textContent = 'Selecionar gênero';
                    } else {
                        link.classList.add('active');
                        activeFilters.genre = genre;
                        genreDropdown.textContent = genre;
                    }
                });
                
                listItem.appendChild(link);
                genresContainer.appendChild(listItem);
            });
        }

        function updateGenreDropdownText(genre) {
            if (genre) {
                genreDropdown.textContent = genre;
                document.querySelectorAll('#genres-container .dropdown-item').forEach(item => {
                    if (item.dataset.genre === genre) {
                        item.classList.add('active');
                    }
                });
            } else {
                genreDropdown.textContent = 'Selecionar gênero';
            }
        }

        function renderCountriesFilter(countries) {
            countryFilter.innerHTML = '<option value="">Todos os países</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        function renderYearsFilter() {
            yearFilter.innerHTML = '<option value="">Todos os anos</option>';
            
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1900; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            }
        }

        function renderPagination() {
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const createPageButton = (page, text, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isActive ? 'active' : ''}`;
                
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = text;
                
                if (page) {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (Object.values(activeFilters).some(val => val !== null && val !== 0 && val !== 10)) {
                            fetchMoviesWithFilters(page);
                        } else {
                            fetchMovies(page, activeFilters.limit);
                        }
                    });
                }
                
                li.appendChild(a);
                return li;
            };
            
            const ul = document.createElement('ul');
            ul.className = 'pagination';
            
            ul.appendChild(createPageButton(currentPage > 1 ? currentPage - 1 : null, 'Anterior', false));
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                ul.appendChild(createPageButton(i, i.toString(), i === currentPage));
            }
            
            ul.appendChild(createPageButton(currentPage < totalPages ? currentPage + 1 : null, 'Próximo', false));
            
            paginationContainer.appendChild(ul);
        }

        function updateActiveFiltersDisplay() {
            activeFiltersContainer.innerHTML = '';
            let hasActiveFilters = false;
            
            if (activeFilters.genre) {
                createFilterBadge('Gênero', activeFilters.genre, () => {
                    activeFilters.genre = null;
                    updateGenreDropdownText(null);
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.year) {
                createFilterBadge('Ano', activeFilters.year, () => {
                    activeFilters.year = null;
                    yearFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.minRating > 0 || activeFilters.maxRating < 10) {
                createFilterBadge('Classificação', `${activeFilters.minRating} - ${activeFilters.maxRating} ⭐`, () => {
                    const ratingSlider = document.getElementById('rating-slider');
                    ratingSlider.noUiSlider.set([0, 10]);
                    activeFilters.minRating = 0;
                    activeFilters.maxRating = 10;
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.type) {
                const typeText = {
                    'movie': 'Filmes',
                    'series': 'Séries',
                    'documentary': 'Documentários'
                }[activeFilters.type] || activeFilters.type;
                
                createFilterBadge('Tipo', typeText, () => {
                    activeFilters.type = null;
                    typeFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (activeFilters.country) {
                createFilterBadge('País', activeFilters.country, () => {
                    activeFilters.country = null;
                    countryFilter.value = '';
                    fetchMoviesWithFilters();
                });
                hasActiveFilters = true;
            }
            
            if (hasActiveFilters) {
                clearFiltersBtn.style.display = 'inline-block';
            } else {
                clearFiltersBtn.style.display = 'none';
            }
        }

        function createFilterBadge(label, value, removeCallback) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-2 mb-2';
            badge.innerHTML = `${label}: ${value} <i class="fas fa-times ms-1" style="cursor: pointer;"></i>`;
            
            badge.querySelector('i').addEventListener('click', removeCallback);
            activeFiltersContainer.appendChild(badge);
        }

        function clearActiveFilters() {
            activeFiltersContainer.innerHTML = '';
            updateGenreDropdownText(null);
            
            const ratingSlider = document.getElementById('rating-slider');
            if (ratingSlider && ratingSlider.noUiSlider) {
                ratingSlider.noUiSlider.set([0, 10]);
            }
            
            yearFilter.value = '';
            typeFilter.value = '';
            countryFilter.value = '';
            
            document.querySelectorAll('.results-per-page-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
            });
            
            clearFiltersBtn.style.display = 'none';
        }

        function clearAllFilters() {
            clearActiveFilters();
            
            activeFilters = {
                genre: null,
                year: null,
                minRating: 0,
                maxRating: 10,
                type: null,
                country: null,
                sort: "imdb.rating:-1",
                limit: 12
            };
            
            sortByFilter.value = "imdb.rating:-1";
            pageTitle.textContent = "Filmes";
        }

        function showLoading() {
            loadingElement.style.display = 'block';
            moviesContainer.style.display = 'none';
            noResultsElement.style.display = 'none';
        }

        function hideLoading() {
            loadingElement.style.display = 'none';
        }

        function showNoResults(message = null) {
            moviesContainer.style.display = 'none';
            noResultsElement.style.display = 'block';
            
            if (message) {
                noResultsElement.querySelector('p').textContent = message;
            } else {
                noResultsElement.querySelector('p').textContent = 'Tente ajustar seus filtros ou fazer uma nova busca.';
            }
            
            paginationContainer.innerHTML = '';
        }
    </script>
</body>
</html>